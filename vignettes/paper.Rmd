---
title: "Evaluating the Mechanisms for Missing Data in the Enhanced Tuberculosis Surveillance System"
author: "Sam Abbott, Hannah Christensen, Ellen Brooks-Pollock"
output: 
      html_document:
      word_document:
        reference_docx: resources/style.docx
vignette: >
  %\VignetteIndexEntry{Explore and Evaluate the Mechanisms for Missing Data in the Enhanced Tuberculosis Surveillance System}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
always_allow_html: true
bibliography: resources/library.bib  
csl: resources/bmj.csl
---


```{r setup, include=FALSE}
## Run code that requires raw data - see data availability for details of how to access the data.
## Used to control which chunks run
regen_results <- FALSE

## Make folders for data and fig storage and return as a path
data_path <- ETSMissing::make_results_folder("paper/data")
fig_path <- ETSMissing::make_results_folder("paper/figs")

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE,
  cache.path = paste0("cache/", "paper" ,"/"),
  fig.width = 8, 
  fig.height = 8)
```


```{r packages, include = FALSE}
library(here)
library(tidyverse)
library(knitr)
library(future)
library(purrr)
library(furrr)
library(forcats)
library(gridExtra)
library(prettypublisher)
library(ETSMissing)
```


```{r utility, include = FALSE}
## Set conveniance function paths using {purrr}
save_data <- purrr::partial(ETSMissing::save_data, path = data_path)
save_figure <- purrr::partial(ETSMissing::save_figure, path = fig_path)
read_data <- purrr::partial(ETSMissing::read_data, path = data_path)
show_figure <- purrr::partial(ETSMissing::show_figure, path = fig_path)
## Set theme
PaperTheme <- theme_minimal() +
  theme(legend.position = "top", text = element_text(size = 12))

ggplot2::theme_set(PaperTheme)
```

**Authors:**

Sam Abbott, Bristol Medical School: Population Health Sciences, University of Bristol, Bristol, UK

Hannah Christensen, Bristol Medical School: Population Health Sciences, University of Bristol, Bristol, UK

Ellen Brooks-Pollock, Bristol Medical School: Population Health Sciences, University of Bristol, Bristol, UK

**Correspondence to:** Sam Abbott, Bristol Medical School: Population Health Sciences, University of Bristol, Bristol BS8 2BN, UK; sam.abbott@bristol.ac.uk; 01173310185

**Words:** *Title:* 12 *Abstract:* 202  *Paper:* 3196

# Abstract

## Background

The Enhanced Tuberculosis Surveillance (ETS) system is a routine surveillance system - with a similar structure to other such systems - that collects data on all notified tuberculosis (TB) cases in England. It is routinely used to study the epidemiology of TB. Routine data often has a large amount of missing data which may not be fully accounted for when used in analyses. This study explores the evidence for associations between missingness in several key outcomes and demographic variables. Any such associations may introduce bias if not accounted for.

## Methods

* Introduce ETS
* Data extraction and management
* Structure of the ETS
* Data completeness
* Drivers of variable completeness (regression)

## Results *Copy from bottom*

* Missing structure
* Drivers of variable completeness

## Conclusions 

* Surveillance data is likely to have a high degree of misising data. In the ETS missing for key outcomes is associated with demographic factors such as....
* To avoid biasing analysis studies should make use of imputed data - rather than complete case analysis - and extend their imputation models to other demographic variables that may not be included in the analysis model. 
* This analysis should be repeated in other datasets - for this reason the code is available as an R package (https://doi.org/10.5281/zenodo.3492200). 

# Introduction

*Background*

The Enhanced Tuberculosis Surveillance (ETS) system is a routine surveillance system - with a similar structure to other such systems - that collects data on all notified tuberculosis (TB) cases in England. It is routinely used to study the epidemiology of TB. Routine data often has a large amount of missing data which may not be fully accounted for when used in analyses. 

*Detail*

*Describe the ETS and use cases*

Missing data can take several forms, data that are missing completely at random (MCAR), data that are missing at random (MAR) and data that are missing not at random (MNAR).[@Sterne2009a] Data that are MAR are missing with a mechanism that is conditional on observed variables, whilst MNAR are missing with a mechanism that is conditional on variables that are not observed. Data that is MAR, and MNAR may lead to biases when analysing the data, however it is not possible to deduce from the observed data what the mechanism driving missing data is. Therefore, it is necessary to account for these potential biases during the analysis stage. This is possible using a variety of methods such as scenario analysis accounting for the 'best' and 'worst' case scenarios, and multiple imputation of missing data using additional variables in the dataset to inform the imputation model.[@Sterne2009a] Common practise is to include all variables included in the analyses in the imputation model, these variables may or may not be those at most risk of introducing bias due to an MAR mechanism.

*Aim*

This study aims to explore the evidence for associations between missingness in several key outcomes and demographic variables. Any such associations may introduce bias if not accounted for.

# Methods

## Enhanced tuberculosis surveillance (ETS) system

```{r load-ets, messages = FALSE, eval = regen_results}
## Load in and clean the ETS extract
## Data cleaning + munging is packaged seperately
## See here: 
if (regen_results) {
  ets <- ETSMissing::read_data("clean_ets_2016", path = here("data-raw/tb_data/tbinenglanddataclean"))
}
```

The ETS is a database that collects demographic, clinical, and microbiological data on all notified TB cases in England and is maintained by Public Health England (PHE). Notification is required by law, with health service providers having to inform PHE of all confirmed TB cases.[@PHE2017] Data collection began in 2000 and was expanded, with additional variables, with the launch of a web based system in 2008.[@Kriujshaar2007] It is updated annually with de-notifications, late notifications and other updates. A descriptive analysis of TB epidemiology in England is published each year, which reports on data collection, cleaning, and trends in TB incidence at both a national, and sub-national level.[@PHE2017] Data on all notifications (114,820 notifications) from the ETS system from 2000 to 2015 were obtained from PHE via an application to the TB monitoring team. The code used for data cleaning is available as an R package (https://zenodo.org/badge/latestdoi/93072437).

### Data completeness

As the ETS is aggregated across England, from a variety of sources, missing data are inevitable. This takes two forms: under-reporting of notified cases, of which there is some evidence in the literature,[@Pillaye2003] and data missing for a notified case. The former is particularly problematic as apart from using comparative studies the characteristics of those that are not notified is unknown. For variables that are missing data within the dataset the proportion of missing data can be calculated but care must be taken to account for nested variables (such as cause of death being dependent on date of death). To account for this when estimating the proportion of missing data we have assumed that nested variables take the value of their parent variable when missing. This approach may be biased for rare outcomes (such as death in the ETS) - for this reason we have also estimated the proportion of missing data by filtering top level variables required for the nested variable to be defined and then computed the proportion of notifications that were missing data for the outcome of interest.  

```{r miss-dat-munge, include = FALSE, eval = regen_results}
if (regen_results) {
  ## See package docs (?ETSMissing::function) for further implementation details 
  # Account for nested data -------------------------------------------------
  nest_filt_ets <- ets %>%
    ETSMissing::account_for_nested_missing()
  
  # Plot nested missing data ------------------------------------------------
  missing_strut <- nest_filt_ets %>%
    ETSMissing::plot_nested_missing()
  
  save_figure(missing_strut, "plot-missing-struct")
  
  # Estimate missing ness pre and post 2009 ---------------------------------
  miss_ets_pre_2009 <- nest_filt_ets %>%
    dplyr::filter(year < 2009) %>%
    ETSMissing::nested_missing_table()
  
  miss_ets_post_2008 <- nest_filt_ets %>%
    dplyr::filter(year > 2008) %>%
    ETSMissing::nested_missing_table()
  
  save_data(miss_ets_pre_2009, "miss_ets_pre_2009")
  save_data(miss_ets_post_2008, "miss_ets_post_2008")
  
  # Summary stats -----------------------------------------------------------
  ## For nested variables an alternative measure of missing data is to consider the number of missing data
  ## points when top level outcome is known
  missing_stats <- ETSMissing::summarise_missingness(ets)
  
  save_data(missing_stats, "missing_stats")
}
```

### Drivers of Variable completeness

**Overview**

Missing data may be MAR or MNAR, which may introduce biases into any analyses based on these data. Unfortunately MNAR data cannot be detected, so bias from this source cannot be discounted. However, it is possible to detect potential MAR mechanisms from observed variables that would not necessarily be included in a model used for analysis. Here we develop a method for this and apply it to several key outcomes including: BCG status, year of BCG vaccination, date of death, cause of death, date of symptom onset, date of diagnosis, date of starting treatment and date of ending treatment. 

We reformulated the problem as a logistic regression for each variable of interest, with the outcome being data completeness (complete/missing). This allows variables that are hypothesised to be related to missing data to be adjusted for and their independent impact on data completeness to be estimated. This approach does not account for missingness within exploratory variables.

**Statistical details**

In order to reformulate missing data as a logistic regression we took the following steps:

1. For the variable of interest create a new temporary binary variable, called data status, that is "Missing" when the variable of interest is missing and "Complete" when it is not. Specify "Complete" as the baseline.

1. For nested variables exclude notifications that do not have the top level outcome required by the variable of interest. An example of this is excluding cases that did not die, or have a missing overall outcome, when investigating TB mortality.

1. Specify the hypothesised drivers of missingness for the variable of interest. These should be variables with a reasonable hypothesis for how they would drive missingness in the variable of interest. They must also be relatively complete as this approach does not impute missing confounder data.

1. Fit a logistic regression model with the temporary data status variable as the outcome, adjusting for the hypothesised drivers of missingness. 

1. Exponentiate the returned coefficients, and confidence intervals so that they represent Odds Ratios (ORs). 

1. Refit the model, dropping each variable in turn and then comparing the updated model with the full model using a likelihood ratio test.

1. Interpret the results, using the estimated size of the effect, the width of the confidence intervals and the size of the Wald and likelihood ratio test p values to determine which variables are related to missingness for the variable of interest. Evidence should be interpreted on a spectrum, rather than using arbitrary significance cut-offs.[@Sterne2001] To avoid issues of multiple testing the level of evidence should be weighted based on the number of variables adjusted for and the number of outcomes explored.

For all outcomes considered we adjusted for the same set of demographic variables that were both highly complete, plausibly linked to missingness for all outcomes considered, and likely to be present in other comparable surveillance datasets. These were: year, sex, age (grouped as 0-14 year olds, 15-65 year olds and 65+), ethnic group, UK birth status and socio-economic status (national quintiles). For socio-economic group 1 indicates the most deprived quintile. Complete case analysis has been used, with the dataset limited to notifications from 2010 and on-wards as socio-economic status was not collected prior to this. The code this approach is available as an R package online (https://doi.org/10.5281/zenodo.3492200).

```{r missing-associations, include = FALSE}
if (regen_results) {
   # Filter to only look at 2009 and move to year as factor ------------------
ets_post_2009 <- ets %>%
  filter(year > 2009, year <= 2015) %>%
  mutate(year = factor(year)) %>% 
  mutate(phec = phec %>% 
           forcats::fct_infreq(ordered = TRUE))
 # Outcome list -----------------------------------------------------------
 
 ## List out outcomes to explore
 outcomes <- tibble(outcome = c("bcgvacc", "bcgvaccyr", "dateofdeath",
                                  "tomdeathrelat", "symptonset", "datediag",
                                  "starttreatdate", "txenddate", "anyres"))
 
 ## Outcome specific data cleaning to deal with nesting issues etc.
 outcomes <- outcomes %>% 
   ## First no outcomes for which no cleaning is needed
   dplyr::mutate(cleaning = case_when(outcome %in% c("bcgvacc", "symptonset", "datediag",
                                                      "starttreatdate", "anyres") ~ c(function(df){
                                                        return(df)
                                                        }),
   ## Then variables for which cases must have died for there to be data
                                      outcome %in% c("dateofdeath", "tomdeathrelat") ~ c(function(df){
                                        df <- dplyr::filter(df, overalloutcome == "Died")
                                        return(df)
                                        }),
  ## Then variables for which cases must have completed treatment for there to be data
                                       outcome %in% c("txenddate") ~ c(function(df){
                                         df <- dplyr::filter(df, overalloutcome %in% c("Treatment completed"))
                                         return(df)
                                         }),
 ## Then variables for which cases must have been BCG vaccinated for there to be data
                                        outcome %in% c("bcgvaccyr") ~ c(function(df){
                                          df <- dplyr::filter(df, bcgvacc == "Yes")
                                          return(df)
                                          })
 ))

 ## Set default exploratory variables --------------------------------------
 confounders_var <- c("year", "sex", "agegrp", "ethgrp", "ukborn", "natquintile", "phec")
 confounder_names <- c("Year", "Sex", "Age", "Ethnic group", "UK birth status", "Socio-economic status", "Public Health England centre")
 
 ## Run analysis  -----------------------------------------------------------
 ## See ?model_variable_missingness for details of model implementation.
 future::plan(future::multiprocess)
 
 results <- outcomes %>% 
  dplyr::mutate(missing_table = furrr::future_map2(outcome, cleaning, ~
                                                 ETSMissing::model_variable_missingness(df = .y(df = ets_post_2009), var = .x, 
                                                                                        confounders = confounders_var,
                                                                                        confounder_names = confounder_names),
                                               .progress = TRUE))
 
 ## Save analysis
 save_data(results, "results")
}else{
## Read in results if not computed
results <- read_data("results")
}
```

### Assessing potential biases in reporting

```{r explore-detection-time-variables, eval = regen_results, include = FALSE}
if (regen_results) {
  plots <- results %>% 
  add_case(outcome = "caserepdate", cleaning = c(function(df){return(df)})) %>% 
  dplyr::select(-missing_table) %>% 
  dplyr::filter(grepl("date", outcome) | outcome %in% c("symptonset")) %>% 
  dplyr::mutate(trends = furrr::future_map2(outcome, cleaning, ~
                                                     ETSMissing::plot_date_variable_missingness(
                                                       df = .y(df = ets), var = .x,
                                                       start_year = 2000, end_year = 2015,
                                                       split_year = 2009),
                                                 .progress = TRUE)) %>% 
  dplyr::mutate(type = map(trends, names)) %>% 
  tidyr::unnest(type, trends) %>% 
  tidyr::pivot_wider(names_from = "type",
              names_prefix = "trends_",
              values_from = "trends")


 ## Save plots
 save_data(plots, "plots")
 
 ## Munge together and save as pngs
plots %>% 
  dplyr::mutate(munged_plots = purrr::map2(trends_by_month, trends_by_day, 
                             ~ gridExtra::grid.arrange(.x + labs(title = "a.)"),
                                            .y + labs(title = "b.)"))
                             )) %>% 
  dplyr::mutate(tmp = purrr::walk2(munged_plots, outcome,
                                   ~ save_figure(.x, paste0("trends-for-", .y))))
}
```

## Patient and public involvement

We did not involve patients or the public in the design or planning of this study.

# Results

## Data completeness

We found high completeness for common demographic variables such as sex, age, ethnic group and UK birth status (`r prettypublisher::pretty_supfigref("plot-missing-struct")`, `r prettypublisher::pretty_tabref("missing-var-tabs")`). More problematically, BCG status and year of BCG status had a high percentage missing, even after accounting for the introduction of national collection of these variables in 2008.[@PHE2017] Socio-economic status (as national quintiles) was not collected until 2010 but after this point is highly complete.[@PHE2017] Comparing pre 2009 and post 2008 in `r prettypublisher::pretty_tabref("missing-var-tabs")` (`r prettypublisher::pretty_supfigref("plot-missing-struct")`) we see completeness changes over time.[@PHE2016; @PHE2017] There was some evidence that groups of variables had correlated missing data (`r prettypublisher::pretty_supfigref("plot-missing-struct")`).

```{r missing-var-tabs}
## Read in results
miss_ets_pre_2009 <- read_data("miss_ets_pre_2009")
miss_ets_post_2008  <- read_data("miss_ets_post_2008")
missing_stats <- read_data("missing_stats")

## Tabulate
miss_ets <- miss_ets_pre_2009 %>% 
  dplyr::select(variable, `2000-2008` = reported) %>% 
  dplyr::left_join(miss_ets_post_2008 %>% 
                     dplyr::select(variable, `2009-2015` = reported), by = "variable") %>% 
  map_variable_names() %>% 
  rename(Variable = variable)
                     
                     

knitr::kable(miss_ets,
      caption = prettypublisher::pretty_tabref("missing-var-tabs", "Percentage of missing data from the ETS for a subset of variables, prior to the web based system (pre 2009) and post (post 2008) by variable, ordered by the  percentage missing for a subset of variables. Nested variables have been accounted for (i.e data of death has had an entry added for cases that are known to have not died), so that true missingness for all variables is estimated."))
```

By filtering nested variables - rather than by using replacement -  we found the date of starting treatment was `r missing_stats[["date_treat"]]` missing, which is more complete than previously estimated. For cases that were known to have completed treatment `r missing_stats[["date_treat_end"]]` were missing a date for the end of treatment. In notifications that were known to have died, `r missing_stats[["date_death"]]` were missing the date of death and `r missing_stats[["cause_death"]]` were missing the cause of death. 

## Drivers of Variable completeness

### BCG status

There was evidence that BCG status was missing with a MAR mechanism for qll variables considered `r prettypublisher::pretty_tabref("bcgvacc-miss")`. BCG data missingness is strongly associated with year of notification, sex age, ethnic group, and socio-economic status. After adjusting for other variables data completeness increased from 2010 until 2012 but has since showed no clear trend. Men appeared to be more likely than women to have a missing BCG status, with the non-UK born also being more likely than the UK born to be missing BCG status. The proportion of those missing BCG status increased with age, with those aged 65+ being over 4 times more likely to be missing BCG status than those aged 0-14 years old. There was also evidence to suggest that notifications in the lowest socio-economic group were more likely to have a missing BCG status but there was no clear evidence of a trend across socio-economic quintiles. The White ethnic group was more likely to have a missing BCG status than any other ethnic group.

```{r bcgvacc-miss}
ETSMissing::pull_results(results, "bcgvacc") %>% 
  knitr::kable(
        caption = prettypublisher::pretty_tabref("bcgvacc-miss", "Results from a logistic regression model with data completeness (Complete/Missing) for BCG vaccination as an outcome, adjusted for: year, sex, age (grouped as 0-14 
                                year olds, 15-65 year olds and 65+), ethnic group, UK birth status and socio-economic status (national quintiles). For socio-economic group 1 indicates the most deprived quintile. 
                                Notifications from 2010 onwards were included as socio-economic status was not collected before this. Complete case analysis was used. Odds ratios shown are adjusted for all 
                                explanatory variables. The model indicates that BCG status is missing at random for the variables considered."))
```

### Year of BCG vaccination

As for BCG status, year of BCG vaccination was also clearly missing with MAR mechanisms for the variables considered (`r prettypublisher::pretty_suptabref("bcgvaccyr-miss")`). As for BCG status men were more likely to have a missing year of BCG vaccination as were the non-UK born. Older notifications were again more likely to have missing data, with those aged 65+ being more than 2 times more likely to have a missing year of vaccination. However, unlike BCG vaccination status, year of notification showed a clear trend of increasing data completeness from 2010 until 2015. Additionally, for year of BCG vaccination the White ethnic group was more likely to have complete data than any other ethnic group, with those of Black-Caribbean descent being over 3 times more likely to have a missing year of BCG vaccination. Socio-economic status was highly associated with year of vaccination being missing but there was little clear evidence of a trend. The second, and third, poorest quintiles were more likely to have a missing year of vaccination. Whilst the richest, and second richest quintiles were less likely to have a missing year of vaccination.

### Date of symptom onset

For date of symptom onset there was strong evidence of an MAR mechanism for all variables considered, except for sex (`r prettypublisher::pretty_tabref("symptonset-miss")`). The likelihood of date of symptom onset being missing reduced with year of notification. Children (0-14 years old) were more likely to have a missing date of symptom onset than any other age group as were those in any socio-economic quintile when compared to the poorest group. UK born cases were more likely to have a complete date of symptom onset than non-UK born cases, with the White ethnic group being more likely to have a missing date of symptom onset than most other ethnic groups.

```{r symptonset-miss}
ETSMissing::pull_results(results, "symptonset") %>% 
  knitr::kable(
        caption = prettypublisher::pretty_tabref("symptonset-miss", "Results from a logistic regression model with data completeness (Complete/Missing) for date of symptom onset as an outcome, adjusted for: 
                                year, sex, age (grouped as 0-14 year olds, 15-65 year olds and 65+), ethnic group, UK birth status and socio-economic status (national quintiles). For 
                                socio-economic group 1 indicates the most deprived quintile. Notifications from 2010 onwards were included as socio-economic status was not collected before 
                                this. Complete case analysis was used. Odds ratios shown are adjusted for all explanatory variables. The model indicates that date of symptom onset is missing 
                                not at random for the variables for all variables considered, except for sex."))
```

### Date of diagnosis

For date of diagnosis there was again strong evidence for an MAR mechanism for all variables considered, except for sex for which there was very weak evidence (`r prettypublisher::pretty_suptabref("datediag-miss")`). Increasing completeness was found for year of notification as seen previously, as was an increased likelihood of missing data in males and the non-UK born. The White ethnic group was less likely to be missing data on the data of diagnosis as compared to the majority of other ethnic groups, as were the poorest socio-economic group compared to all other socio-economic quintiles. Children (0-14 years old) were again more likely to be missing data than adults in any age group.

### Date of starting treatment and ending treatment

For date of starting treatment there was little evidence that missing data is associated with any variable considered, except for year of notification (`r prettypublisher::pretty_suptabref("starttreatdate-miss")`). Variable completeness improved year-on-year with a 96% drop in missing data in 2015 compared to 2010. Missing data for  the date of ending treatment had a comparable association with the year of notification but also had weak evidence of an association with ethnic group and socio-economic status (`r prettypublisher::pretty_suptabref("txenddate-miss")`). There was some evidence that the poorest socio-economic group was more likely to be missing the date of ending treatment but the evidence for this was mixed. The White ethnic group was slightly more likely to be missing the date of treatment ending than most other ethnic groups. 

### Date of death

For date of death there was some evidence that data was missing with an MAR mechanism for ethnic group and socio-economic status with little evidence for any other association (`r prettypublisher::pretty_suptabref("dateofdeath-miss")`). These associations should be interpreted carefully due to the strength of the evidence when compared to the number of tests conducted. Whilst the confidence intervals were wide for all ethnic groups there was some weak indication that the White ethnic group were more likely to have a complete date of death than other ethnic groups. Similarly, those in the lowest socio-economic group were somewhat more likely to have a complete date of death than other quintiles. The reduction in the levels of evidence found for case of death may be linked to the reduction in power for this outcome, as mortality is a rare outcome.

### Cause of death

For cause of death there was less evidence of an MAR mechanism, with little evidence of an association for year, sex, age, or socio-economic group (`r prettypublisher::pretty_suptabref("tomdeathrealat-miss")`). However, there was evidence of an association with ethnic group and very weak evidence of an association with UK birth status. The White ethnic group was less likely to have an incomplete cause of death when compared to the majority of other identified ethnic groups but there was weak evidence to suggest that cause of death was in fact less likely to be missing in those identifying as being of Black-Caribbean, Black-Other, Indian and Bangladeshi descent. The confidence intervals for these estimates were wide, indicating that these estimates may not be reliable. There was again some weak evidence to suggest that the UK born were more likely to be missing a cause of death than the non-UK born, which reverses the trend observed in the other variables explored. As for the date of death cause of death had a small sample size and this may mean that this analysis was underpowered. 

## Assessing potential biases in reporting

* Describe pattern in notifications by month and within months. 
* Describe which variables also follow this pattern.
* Discuss variables with potential recall bias. 


It is also likely that some of the dates recorded are inaccurate or systematically biased. 

date of notification can be used as a baseline on which to judge other date variables

There is some evidence of a seasonal trend in notifications, with a higher proportion of cases notified in the May, June and July than in the rest of the year. This seasonality would have to be accounted for if conducting analysis on a monthly scale and date of notification was being used as the date of first contact with the health system. There is little evidence that date of notification varies by day of the month.

date of symptom onset, this represents the closest approximation to the date when a case became infectious. Unfortunately there are multiple issues with this measure, the first of which being is that it is only complete across the data extract.

The date of symptom onset is highly susceptible to recall bias with the majority of cases becoming symptomatic on the first of each month, with some evidence that a greater number of cases occur in January than would be expected. 

Another possible measure of the number of cases is the date of diagnosis, this should be a more reliable variable than the date of symptom onset, as it does not rely on the recall of the case. 

The date of starting treatment should be a more reliable contact date as it records an official contact with the health system. As for the data of notification there is some evidence of a seasonal trend for date of starting treatment, with a peak of cases starting treatment in May, June and July. However, this seasonal trend is difficult to identify when cases starting treatment are visualised by month over time. Unlike the date of symptom onset there is little evidence of recall bias by month, or by day. 

The date of ending treatment does not appear to display similar seasonality. This maybe because treatment time varies between individuals and this dilutes the seasonality observed for the date of starting treatment. As noted previously, there was some evidence of recall bias when the proportion of those ending treatment was examined on a day of the month basis, with a larger proportion ending treatment on the first of the month than on any other day. The date of ending treatment was not recorded in 2000, or 2001, and was highly missing for the first several years after collection began.

```{r plot-trends-caserepdate, fig.cap = prettypublisher::pretty_figref("plot-trends-caserepdate", "a.) Shows the proportion of cases finishing treatment in a given month for each year, with little evidence of a seasonal trend. b.) Shows the proportion of cases finishing treatment on a given day for each month, with a much higher proportion of cases finishing treatment on the first of the month than would be expected. On the scale of months there is some evidence of recall bias, with the first day reporting higher proportions of cases than would be expected. Data is only shown from 2001 until 2015 and prior to 2001 this variable was not recorded and it is not complete for 2015."), out.width = "60%", out.extra = ""}
show_figure("trends-for-caserepdate")
```

```{r plot-trends-symptonset, fig.cap = prettypublisher::pretty_figref("plot-trends-symptonset", "a.) Shows the proportion of cases finishing treatment in a given month for each year, with little evidence of a seasonal trend. b.) Shows the proportion of cases finishing treatment on a given day for each month, with a much higher proportion of cases finishing treatment on the first of the month than would be expected. On the scale of months there is some evidence of recall bias, with the first day reporting higher proportions of cases than would be expected. Data is only shown from 2001 until 2015 and prior to 2001 this variable was not recorded and it is not complete for 2015."), out.width = "60%", out.extra = ""}
show_figure("trends-for-symptonset")
```

# Discussion

### Statement of primary findings

In the ETS system we found a high degree of missing data for several important variables. We also found that there is likely to be strong missing at random (MAR) mechanism underlying this missing data for multiple variables. Several factors are strongly associated with data being missing for many variables, including UK birth status, ethnic group, socio-economic status and year. These MAR mechanisms must be adjusted for in studies using this data to avoid introducing bias. We found that date variables in particular suffered from changing data completeness over time, which may introduce spurious temporal trends if not fully understood. 

*The following analysis is not currently in the paper but it was in the chapter - is there a case for including?*

We also found that for several variables, including the date of symptom onset, there was a large degree of recall bias when aggregating by day or month. Several variables, including date of notification and date of starting treatment, showed a seasonal trend with a maximum in the summer months. The date of ending treatment showed less evidence of a seasonal trend.

### Strengths and limitations of the study

*Work in progress - copied from chapter text*

Routine observational datasets are subject to numerous potential biases, such as selection bias, recall bias, measurement bias, and unmeasured confounding.[@Benchimol2016a] Additionally, as the data has not been collected with a specific analysis in mind there maybe issues with the specificity of variables. The ETS system is likely to suffer from all of the above biases to some extent, which must be accounted for as far as possbile, and explicitly stated at every level of analysis. The most important consideration is that the ETS system is unlikely to be representative of the general population as it contains only notified TB cases that occurred in England during the study period, research questions must therefore be either limited to active TB patients, or when extended to the general population the differing population demographics must be accounted for. If this is not done then any results may be due to selection bias. Additionally, multiple variables may suffer from misclassification bias, including BCG status which can be assessed via vaccination record, the presence of a scar, or case recall: this may lead to spurious associations.[@Fewell2007] Validation studies would be required to account for this. 


Unlike classic approaches to missing data, such as multiple imputation by chained regression (MICE),[@Groothuis-oudshoorn] this is not an imputation

### Strengths and limitations in comparison to the literature
    
### Meaning of the study

* Surveillance data is likely to have a high degree of missing data. In the ETS missing for key outcomes is associated with demographic factors such as....
* To avoid biasing analysis studies should make use of imputed data - rather than complete case analysis - and extend their imputation models to other demographic variables that may not be included in the analysis model. 

### Unanswered questions and future research

* This analysis should be repeated in other datasets - for this reason the code is available as an R package (https://doi.org/10.5281/zenodo.3492200). 


**Acknowledgements**

The authors thank the TB section at Public Health England (PHE) for maintaining the Enhanced Tuberculosis Surveillance (ETS) system; all the healthcare workers involved in data collection for the ETS.

**Contributors**

SA conceived and designed the work. SA undertook the analysis with advice from all other authors. All authors contributed to the interpretation of the data. SA wrote the first draft of the paper and all authors contributed to subsequent drafts. All authors approve the work for publication and agree to be accountable for the work.

**Funding** 

SEA, HC, and EBP are funded by the National Institute for Health Research Health Protection Research Unit (NIHR HPRU) in Evaluation of Interventions at University of Bristol in partnership with Public Health England (PHE). The views expressed are those of the author(s) and not necessarily those of the NHS, the NIHR, the Department of Health or Public Health England.

**Conflicts of interest** 

HC reports receiving honoraria from Sanofi Pasteur, and consultancy fees from AstraZeneca, GSK and IMS Health, all paid to her employer.

**Accessibility of programming code**

The code for the analysis contained in this paper can be found at: https://doi.org/10.5281/zenodo.3492200


# References

<div id = 'refs'></div>

## Results *Copy to top*


# Supplementary Information: Explore and Evaluate the Mechanisms for Missing Data in the Enhanced Tuberculosis Surveillance System

Sam Abbott, Hannah Christensen, Ellen Brooks-Pollock

## Data completeness

```{r plot-missing-struct, fig.cap = prettypublisher::pretty_supfigref("plot-missing-struct", "Summary plot of missing data in the extract of the ETS data used in this thesis. Due to the large size of the dataset, the data has been sub-sampled with only 20\\% of the data shown in this figure. Notifications have been ordered by date of notification from left to right. The following subset of variables are shown: year (year), sex (sex), age (age), PHE Centre (phec), Occupation (occat), Ethnic group (ethgrp), UK birth status (ukborn), Time since entry (timesinceent), date of symptom onset (symptonset), date of diagnosis (datediag), started treatment (startedtreat), date of starting treatment (starttreatdate), treatment end date (txenddate), pulmonary or extra-pulmonary TB (pulmextrapulm), culture (culture), sputum smear status (sputsmear), drug resistance (anyres), previous diagnosis (prevdiag), BCG status(bcgvacc), Year of BCG vaccination (bcgvaccyr), overall outcome (overalloutcome), cause of death (tomdeathrelate), socio-economic status quintiles (natquintile), and date of death (dateofdeath). Nested variables have been accounted for (i.e date of death has had an entry added for cases that are known to have not died), so that true missingness for all variables is estimated."), out.width = "60%", out.extra = ""}
show_figure("plot-missing-struct")
```


## Drivers of data completeness - additional results tables

### Year of BCG vaccination

```{r bcgvaccyr-miss}
ETSMissing::pull_results(results, "bcgvaccyr") %>% 
  knitr::kable(
        caption = prettypublisher::pretty_suptabref("bcgvaccyr-miss", "Results from a logistic regression model with data completeness (Complete/Missing) for year of BCG vaccination as an outcome, adjusted for: year, sex, age (grouped 
                                as 0-14 year olds, 15-65 year olds and 65+), ethnic group, UK birth status and socio-economic status (national quintiles). For socio-economic group 1 indicates the most deprived 
                                quintile. Notifications from 2010 onwards were included as socio-economic status was not collected before this. Complete case analysis was used. Odds ratios shown are adjusted for all 
                                explanatory variables. The model indicates that year of BCG vaccination is missing at random for the variables considered."))
```

### Date of diagnosis

```{r datediag-miss}
ETSMissing::pull_results(results, "datediag") %>% 
  knitr::kable(
        caption = prettypublisher::pretty_suptabref("datediag-miss", "Results from a logistic regression model with data completeness (Complete/Missing) for date of diagnosis onset as an 
                                outcome, adjusted for: year, sex, age (grouped as 0-14 year olds, 15-65 year olds and 65+), ethnic group, UK birth status and socio-economic status 
                                (national quintiles). For socio-economic group 1 indicates the most deprived quintile. Notifications from 2010 onwards were included as socio-economic 
                                status was not collected before this. Complete case analysis was used. Odds ratios shown are adjusted for all explanatory variables. The model indicates that 
                                date of diagnosis is missing at random for the variables for all variables considered, except for sex."))
```


### Date of starting treatment and ending treatment

```{r starttreatdate-miss}
ETSMissing::pull_results(results, "starttreatdate") %>% 
  knitr::kable(
      caption =  prettypublisher::pretty_suptabref("starttreatdate-miss", "Results from a logistic regression model with data completeness (Complete/Missing) for date of starting
                               treatment as an outcome, adjusted for: year, sex, age (grouped as 0-14 year olds, 15-65 year olds and 65+), ethnic group, UK birth
                               status and socio-economic status (national quintiles). For socio-economic group 1 indicates the most deprived quintile. Notifications
                               from 2010 onwards were included as socio-economic status was not collected before this. Complete case analysis was used. Odds ratios
                               shown are adjusted for all explanatory variables. There is little evidence that the missing data for the date of starting treatment
                               is associated with any variable considered, except for year of notification."))
```


```{r txenddate-miss}
ETSMissing::pull_results(results, "txenddate") %>% 
  knitr::kable(
        caption = prettypublisher::pretty_suptabref("txenddate-miss", "Results from a logistic regression model with data completeness (Complete/Missing) for date of starting treatment
                                as an outcome, adjusted for: year, sex, age (grouped as 0-14 year olds, 15-65 year olds and 65+), ethnic group, UK birth status and
                                socio-economic status (national quintiles). For socio-economic group 1 indicates the most deprived quintile. Notifications from 2010
                                onwards were included as socio-economic status was not collected before this. Complete case analysis was used. Odds ratios shown are
                                adjusted for all explanatory variables. There is little evidence that the missing data for the date of starting treatment is
                                associated with any variable considered, except for year of notification."))
```

### Date of death


```{r dateofdeath-miss}
ETSMissing::pull_results(results, "dateofdeath") %>% 
  knitr::kable(
        caption = prettypublisher::pretty_suptabref("dateofdeath-miss", "Results from a logistic regression model with data completeness (Complete/Missing) for date of death as an outcome, adjusted for: year, sex, age (grouped as 
                                0-14 year olds, 15-65 year olds and 65+), ethnic group, UK birth status and socio-economic status (national quintiles). For socio-economic group 1 indicates the most deprived 
                                quintile. Notifications from 2010 onwards were included as socio-economic status was not collected before this. Complete case analysis was used. Odds ratios shown are adjusted for 
                                all explanatory variables. The model indicates that there is some evidence that date of death is missing at random for ethnic group, with weaker evidence for all other variables."))
```

### Cause of death


```{r tomdeathrealat-miss}
ETSMissing::pull_results(results, "tomdeathrelat") %>% 
  knitr::kable(
        caption = prettypublisher::pretty_suptabref("tomdeathrealat-miss", "Results from a logistic regression model with data completeness (Complete/Missing) for cause of death as an outcome, adjusted for: year, 
                                sex, age (grouped as 0-14 year olds, 15-65 year olds and 65+), ethnic group, UK birth status and socio-economic status (national quintiles). For socio-economic group 1 indicates 
                                the most deprived quintile. Notifications from 2010 onwards were included as socio-economic status was not collected before this. Complete case analysis was used. Odds ratios 
                                shown are adjusted for all explanatory variables. The model indicates that cause of death is missing at random for ethnic group and UK birth status, with little evidence for any 
                                other variables"))
```


### Assessing potential biases in reporting


```{r plot-trends-datediag, fig.cap = prettypublisher::pretty_supfigref("plot-trends-datediag", "a.) Shows the proportion of cases finishing treatment in a given month for each year, with little evidence of a seasonal trend. b.) Shows the proportion of cases finishing treatment on a given day for each month, with a much higher proportion of cases finishing treatment on the first of the month than would be expected. On the scale of months there is some evidence of recall bias, with the first day reporting higher proportions of cases than would be expected. Data is only shown from 2001 until 2015 and prior to 2001 this variable was not recorded and it is not complete for 2015."), out.width = "60%", out.extra = ""}
show_figure("trends-for-datediag")
```


```{r plot-trends-dateofdeath, fig.cap = prettypublisher::pretty_supfigref("plot-trends-dateofdeath", "a.) Shows the proportion of cases finishing treatment in a given month for each year, with little evidence of a seasonal trend. b.) Shows the proportion of cases finishing treatment on a given day for each month, with a much higher proportion of cases finishing treatment on the first of the month than would be expected. On the scale of months there is some evidence of recall bias, with the first day reporting higher proportions of cases than would be expected. Data is only shown from 2001 until 2015 and prior to 2001 this variable was not recorded and it is not complete for 2015."), out.width = "60%", out.extra = ""}
show_figure("trends-for-dateofdeath")
```



```{r plot-trends-starttreatdate, fig.cap = prettypublisher::pretty_supfigref("plot-trends-starttreatdate", "a.) Shows the proportion of cases finishing treatment in a given month for each year, with little evidence of a seasonal trend. b.) Shows the proportion of cases finishing treatment on a given day for each month, with a much higher proportion of cases finishing treatment on the first of the month than would be expected. On the scale of months there is some evidence of recall bias, with the first day reporting higher proportions of cases than would be expected. Data is only shown from 2001 until 2015 and prior to 2001 this variable was not recorded and it is not complete for 2015."), out.width = "60%", out.extra = ""}
show_figure("trends-for-starttreatdate")
```




```{r plot-trends-txenddate, fig.cap = prettypublisher::pretty_supfigref("plot-trends-txenddate", "a.) Shows the proportion of cases finishing treatment in a given month for each year, with little evidence of a seasonal trend. b.) Shows the proportion of cases finishing treatment on a given day for each month, with a much higher proportion of cases finishing treatment on the first of the month than would be expected. On the scale of months there is some evidence of recall bias, with the first day reporting higher proportions of cases than would be expected. Data is only shown from 2001 until 2015 and prior to 2001 this variable was not recorded and it is not complete for 2015."), out.width = "60%", out.extra = ""}
show_figure("trends-for-txenddate")
```
